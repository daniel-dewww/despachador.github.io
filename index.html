<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Despachador -  Directo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0A50E6;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #0A50E6;
            font-size: 28px;
        }

        .header .status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .live-indicator {
            width: 12px;
            height: 12px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #0A50E6;
            color: white;
        }

        .btn-primary:hover {
            background: #053baf;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        input[type="file"] {
            padding: 8px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h3 {
            color: #0A50E6;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-number {
            font-size: 36px;
            font-weight: 700;
            color: #0A50E6;
        }

        .stat-label {
            color: #6b7280;
            font-size: 14px;
            margin-top: 5px;
        }

        .table-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f3f4f6;
        }

        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        tbody tr:hover {
            background: #f9fafb;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-anillo-1 {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-anillo-2 {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-anillo-3 {
            background: #fed7aa;
            color: #7c2d12;
        }

        .badge-anillo-4 {
            background: #fecaca;
            color: #991b1b;
        }

        .badge-ok {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-ocupado {
            background: #fecaca;
            color: #991b1b;
        }

        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline-item {
            position: relative;
            padding-bottom: 20px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -24px;
            top: 5px;
            width: 12px;
            height: 12px;
            background: #0A50E6;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 0 2px #0A50E6;
        }

        .timeline-item::after {
            content: '';
            position: absolute;
            left: -18px;
            top: 17px;
            width: 2px;
            height: calc(100% - 12px);
            background: #e5e7eb;
        }

        .timeline-item:last-child::after {
            display: none;
        }

        .timeline-time {
            font-family: monospace;
            color: #6b7280;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .timeline-content {
            background: #f9fafb;
            padding: 10px;
            border-radius: 8px;
            border-left: 3px solid #0A50E6;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-info {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            color: #1e40af;
        }

        .alert-warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            color: #92400e;
        }

        #autoRefresh {
            margin-left: auto;
        }

        .filter-bar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .filter-bar input, .filter-bar select {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1> <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcREIA-YqkfFFwS1fR_6VZ4lh15r88cfFh3b3w&s" alt="Directo Logo" width="20"> Monitor de Despachador</h1>
                <p style="color: #6b7280; margin-top: 5px;">Sistema Taxi Directo - An√°lisis en Tiempo Real</p>
            </div>
            <div class="status">
                <div class="live-indicator"></div>
                <span style="font-weight: 600;">En Vivo</span>
                <span id="lastUpdate" style="color: #6b7280; margin-left: 10px;">--:--:--</span>
            </div>
        </div>

        <!-- Alert -->
        <div class="alert alert-info">
            <strong>‚ÑπÔ∏è Informaci√≥n:</strong> Esta p√°gina lee los archivos CSV generados por el despachador. 
            Coloca los archivos .csv en la misma carpeta que este HTML o c√°rgalos manualmente.
        </div>

        <!-- Controls -->
        <div class="controls">
            <input type="file" id="csvFile" accept=".csv" class="btn">
            <button onclick="loadCSV()" class="btn btn-primary">üìä Cargar CSV</button>
            <button onclick="clearData()" class="btn btn-danger">üóëÔ∏è Limpiar Datos</button>
            <!-- <label style="margin-left: auto; display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="autoRefresh" onchange="toggleAutoRefresh()">
                <span>Auto-actualizar cada 5s</span>
            </label> -->
        </div>

        <!-- Stats -->
        <div class="grid">
            <div class="card">
                <h3>üìã Total Eventos</h3>
                <div class="stat-number" id="totalEventos">0</div>
                <div class="stat-label">Registros procesados</div>
            </div>
            <div class="card">
                <h3>üöó Servicios √önicos</h3>
                <div class="stat-number" id="totalServicios">0</div>
                <div class="stat-label">Servicios despachados</div>
            </div>
            <!-- <div class="card">
                <h3>‚è±Ô∏è Tiempo Promedio</h3>
                <div class="stat-number" id="tiempoPromedio">--</div>
                <div class="stat-label">Por anillo (segundos)</div>
            </div> -->
            <!-- <div class="card">
                <h3>‚ö†Ô∏è Problemas Detectados</h3>
                <div class="stat-number" id="problemasDetectados">0</div>
                <div class="stat-label">Servicios con saltos de anillo</div>
            </div> -->
        </div>

        <!-- Filters -->
        <div class="table-container">
            <h3 style="color: #0A50E6; margin-bottom: 15px;">üîç Filtros de B√∫squeda</h3>
            <div class="filter-bar">
                <input type="text" id="filterServicio" placeholder="ID Servicio" onkeyup="filterTable()">
                <select id="filterAnillo" onchange="filterTable()">
                    <option value="">Todos los anillos</option>
                    <option value="1">Anillo 1</option>
                    <option value="2">Anillo 2</option>
                    <option value="3">Anillo 3</option>
                    <option value="4">Anillo 4</option>
                </select>
                <input type="text" id="filterAccion" placeholder="Acci√≥n" onkeyup="filterTable()">
                <input type="text" id="filterConductor" placeholder="ID Conductor" onkeyup="filterTable()">
            </div>

            <!-- Table -->
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Servicio</th>
                        <th>Anillo</th>
                        <th>Acci√≥n</th>
                        <th>Detalles</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: #9ca3af;">
                            No hay datos cargados. Por favor carga un archivo CSV.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Timeline Section -->
        <div class="card" style="margin-top: 20px;" id="timelineSection" hidden>
            <h3>üìÖ Timeline del Servicio <span id="timelineServicioId"></span></h3>
            <div class="timeline" id="timelineContainer"></div>
        </div>
    </div>

    <script>
        let allData = [];
        let autoRefreshInterval = null;

        // Cargar CSV
        function loadCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Por favor selecciona un archivo CSV');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                parseCSV(text);
            };
            reader.readAsText(file);
        }

        // Parsear CSV
        function parseCSV(text) {
            const lines = text.split('\n');
            const data = [];
            
            // Saltar header
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Parse CSV teniendo en cuenta comillas
                const matches = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                if (matches && matches.length >= 4) {
                    data.push({
                        timestamp: matches[0].replace(/"/g, ''),
                        idServicio: matches[1].replace(/"/g, ''),
                        anillo: matches[2].replace(/"/g, ''),
                        accion: matches[3].replace(/"/g, ''),
                        detalles: matches[4] ? matches[4].replace(/"/g, '') : ''
                    });
                }
            }
            
            allData = data;
            updateStats();
            displayData(data);
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        // Actualizar estad√≠sticas
        function updateStats() {
            document.getElementById('totalEventos').textContent = allData.length;
            
            const serviciosUnicos = new Set(allData.map(d => d.idServicio)).size;
            document.getElementById('totalServicios').textContent = serviciosUnicos;
            
            // Detectar problemas (saltos de anillo r√°pidos)
            // const problemas = detectarProblemas();
            // document.getElementById('problemasDetectados').textContent = problemas;
            
            // Calcular tiempo promedio entre anillos
            //const tiempoPromedio = calcularTiempoPromedio();
            //document.getElementById('tiempoPromedio').textContent = tiempoPromedio;
        }

        // Detectar servicios con saltos de anillo
        // function detectarProblemas() {
        //     const servicios = {};
        //     let problemas = 0;
            
        //     allData.forEach(row => {
        //         if (!servicios[row.idServicio]) {
        //             servicios[row.idServicio] = [];
        //         }
        //         servicios[row.idServicio].push({
        //             timestamp: row.timestamp,
        //             anillo: parseInt(row.anillo),
        //             accion: row.accion
        //         });
        //     });
            
        //     Object.keys(servicios).forEach(idServicio => {
        //         const eventos = servicios[idServicio].sort((a, b) => 
        //             new Date('1970/01/01 ' + a.timestamp) - new Date('1970/01/01 ' + b.timestamp)
        //         );
                
        //         for (let i = 1; i < eventos.length; i++) {
        //             const prev = eventos[i - 1];
        //             const curr = eventos[i];
                    
        //             const timeDiff = (new Date('1970/01/01 ' + curr.timestamp) - 
        //                              new Date('1970/01/01 ' + prev.timestamp)) / 1000;
                    
        //             // Si cambi√≥ de anillo en menos de 10 segundos
        //             if (curr.anillo > prev.anillo && timeDiff < 10) {
        //                 problemas++;
        //                 break;
        //             }
        //         }
        //     });
            
        //     return problemas;
        // }

        // Calcular tiempo promedio
        // function calcularTiempoPromedio() {
        //     const tiempos = [];
        //     const servicios = {};
            
        //     allData.forEach(row => {
        //         if (!servicios[row.idServicio]) {
        //             servicios[row.idServicio] = [];
        //         }
        //         servicios[row.idServicio].push({
        //             timestamp: row.timestamp,
        //             anillo: parseInt(row.anillo)
        //         });
        //     });
            
        //     Object.values(servicios).forEach(eventos => {
        //         for (let i = 1; i < eventos.length; i++) {
        //             const timeDiff = (new Date('1970/01/01 ' + eventos[i].timestamp) - 
        //                              new Date('1970/01/01 ' + eventos[i-1].timestamp)) / 1000;
        //             tiempos.push(timeDiff);
        //         }
        //     });
            
        //     if (tiempos.length === 0) return '--';
            
        //     const promedio = tiempos.reduce((a, b) => a + b, 0) / tiempos.length;
        //     return promedio.toFixed(1) + 's';
        // }

        // Mostrar datos en tabla
        function displayData(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #9ca3af;">No hay datos para mostrar</td></tr>';
                return;
            }
            
            data.slice().reverse().forEach(row => {
                const tr = document.createElement('tr');
                tr.style.cursor = 'pointer';
                tr.onclick = () => showTimeline(row.idServicio);
                
                const anilloClass = `badge-anillo-${row.anillo}`;
                
                tr.innerHTML = `
                    <td style="font-family: monospace;">${row.timestamp}</td>
                    <td><strong>${row.idServicio}</strong></td>
                    <td><span class="badge ${anilloClass}">Anillo ${row.anillo}</span></td>
                    <td>${row.accion}</td>
                    <td style="color: #6b7280; font-size: 13px;">${row.detalles}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Filtrar tabla
        function filterTable() {
            const filterServicio = document.getElementById('filterServicio').value.toLowerCase();
            const filterAnillo = document.getElementById('filterAnillo').value;
            const filterAccion = document.getElementById('filterAccion').value.toLowerCase();
            const filterConductor = document.getElementById('filterConductor').value.toLowerCase();
            
            const filtered = allData.filter(row => {
                return (
                    (filterServicio === '' || row.idServicio.toLowerCase().includes(filterServicio)) &&
                    (filterAnillo === '' || row.anillo === filterAnillo) &&
                    (filterAccion === '' || row.accion.toLowerCase().includes(filterAccion)) &&
                    (filterConductor === '' || row.detalles.toLowerCase().includes(filterConductor))
                );
            });
            
            displayData(filtered);
        }

        // Mostrar timeline
        function showTimeline(idServicio) {
            const servicioData = allData.filter(d => d.idServicio === idServicio);
            const section = document.getElementById('timelineSection');
            const container = document.getElementById('timelineContainer');
            
            document.getElementById('timelineServicioId').textContent = idServicio;
            container.innerHTML = '';
            
            servicioData.forEach(evento => {
                const item = document.createElement('div');
                item.className = 'timeline-item';
                item.innerHTML = `
                    <div class="timeline-time">${evento.timestamp}</div>
                    <div class="timeline-content">
                        <strong>${evento.accion}</strong> - Anillo ${evento.anillo}
                        <div style="color: #6b7280; font-size: 13px; margin-top: 5px;">${evento.detalles}</div>
                    </div>
                `;
                container.appendChild(item);
            });
            
            section.hidden = false;
            section.scrollIntoView({ behavior: 'smooth' });
        }

        // Limpiar datos
        function clearData() {
            if (confirm('¬øEst√°s seguro de limpiar todos los datos?')) {
                allData = [];
                updateStats();
                displayData([]);
                document.getElementById('timelineSection').hidden = true;
                document.getElementById('csvFile').value = '';
            }
        }

        // Auto-refresh
        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            
            if (checkbox.checked) {
                autoRefreshInterval = setInterval(() => {
                    const fileInput = document.getElementById('csvFile');
                    if (fileInput.files[0]) {
                        loadCSV();
                    }
                }, 5000);
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        }
    </script>
</body>
</html>